set -e

# Available variables:
# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package

tar xzf golang/go1.18.5.linux-amd64.tar.gz
export GOROOT="${BOSH_COMPILE_TARGET}/go"

mkdir $BOSH_COMPILE_TARGET/gopath
mkdir $BOSH_COMPILE_TARGET/gocache
export GOPATH=$BOSH_COMPILE_TARGET/gopath
export GOCACHE=$BOSH_COMPILE_TARGET/gocache

echo "Build libpcap"
LIBPCAP_VERSION="1.10.1"
mkdir "${BOSH_COMPILE_TARGET}/libpcap"
tar xzf libpcap-${LIBPCAP_VERSION}.tgz --strip-components 1 -C "${BOSH_COMPILE_TARGET}/libpcap"

pushd "${BOSH_COMPILE_TARGET}/libpcap"
  ./configure
  make
popd

echo "Build pcap-agent"
pushd pcap-agent
  # -I/-L adds the local libpcap to the search directory for compiler and linker
  # -ldflags makes the linker link all libraries statically to avoid relying on some local library to be present
  CGO_CFLAGS="-I${BOSH_COMPILE_TARGET}/libpcap" CGO_LDFLAGS="-L${BOSH_COMPILE_TARGET}/libpcap" "${GOROOT}/bin/go" build -a -ldflags '-linkmode external -extldflags -static' -o "${BOSH_INSTALL_TARGET}/bin/pcap-agent"
popd
